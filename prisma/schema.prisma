generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String              @id @default(uuid())
  name               String
  username           String              @unique
  email              String              @unique
  passwordHash       String?
  role               UserRole            @default(client)
  referralCode       String?             @unique
  clientId           String              @unique
  referredById       String?
  emailVerified      Boolean             @default(false)
  onboarded          Boolean             @default(false)
  has_paid           Boolean             @default(false)
  subscriptionStatus SubscriptionStatus? @default(trial)
  subscriptionType   String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accounts           Account[]
  affiliate          Affiliate?
  payments           Payment[]
  referredUsers      Referral?           @relation("ReferredUsers")
  sessions           Session[]
  subscription       Subscription?
  referrer           User?               @relation("Referrer", fields: [referredById], references: [id])
  referrals          User[]              @relation("Referrer")
  withdrawalRequests WithdrawalRequest[]
  notifications      Notification[]
  auditLogs          AuditLog[]

  @@index([referralCode])
  @@map("users")
}

model Affiliate {
  id             String          @id @default(uuid())
  userId         String          @unique
  commissionRate Float           @default(0.15)
  payoutMethod   String?
  status         AffiliateStatus @default(active)
  availableBalance Float          @default(0)
  totalEarned     Float          @default(0)
  pendingBalance  Float          @default(0)
  mpesaName       String?
  createdAt      DateTime        @default(now())
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions    Commission[]
  referrals      Referral[]      @relation("AffiliateReferrals")

  @@map("affiliates")
}

model Referral {
  id                  String         @id @default(uuid())
  affiliateId         String
  referredUserId      String         @unique
  clickTimestamp      DateTime       @default(now())
  conversionTimestamp DateTime?
  status              ReferralStatus @default(active)
  createdAt           DateTime       @default(now())
  affiliate           Affiliate      @relation("AffiliateReferrals", fields: [affiliateId], references: [id])
  referredUser        User           @relation("ReferredUsers", fields: [referredUserId], references: [id])

  @@unique([affiliateId, referredUserId])
  @@map("referrals")
}

model Payment {
  id            String        @id @default(uuid())
  userId        String
  amount        Float
  currency      String        @default("KES")
  status        PaymentStatus @default(pending)
  paymentMethod String
  transactionId String?       @unique
  planType      String
  createdAt     DateTime      @default(now())
  commissions   Commission[]
  user          User          @relation(fields: [userId], references: [id])

  @@map("payments")
}

model Commission {
  id               String           @id @default(uuid())
  affiliateId      String
  paymentId        String
  commissionAmount Float
  status           CommissionStatus @default(pending)
  createdAt        DateTime         @default(now())
  paidAt           DateTime?
  affiliate        Affiliate        @relation(fields: [affiliateId], references: [id])
  payment          Payment          @relation(fields: [paymentId], references: [id])

  @@unique([affiliateId, paymentId])
  @@map("commissions")
}

model Plan {
  id            String         @id @default(uuid())
  name          String         @unique
  slug          String         @unique
  price         Float
  currency      String         @default("KES")
  features      String[]
  isActive      Boolean        @default(true)
  sortOrder     Int            @default(0)
  type          PlanType       @default(subscription)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                 String             @id @default(uuid())
  userId             String             @unique
  planId             String
  status             SubscriptionStatus @default(trial)
  currentPeriodStart DateTime           @default(now())
  currentPeriodEnd   DateTime
  trialEndsAt        DateTime?
  cancelledAt        DateTime?
  paymentMethod      String?
  autoRenew          Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  plan               Plan               @relation(fields: [planId], references: [id])
  user               User               @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model WithdrawalRequest {
  id            String           @id @default(uuid())
  userId        String
  phoneNumber   String
  mpesaName     String?
  amount        Float
  status        WithdrawalStatus @default(pending)
  transactionId String?
  failureReason String?
  processedAt   DateTime?
  createdAt     DateTime         @default(now())
  user          User             @relation(fields: [userId], references: [id])

  @@map("withdrawal_requests")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  message   String
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model AuditLog {
  id        String    @id @default(uuid())
  action    String
  details   Json
  userId    String?
  targetId  String?
  createdAt DateTime  @default(now())
  user      User?     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

enum UserRole {
  admin
  affiliate
  client
}

enum AffiliateStatus {
  active
  inactive
  suspended
}

enum ReferralStatus {
  active
  inactive
  converted
}

enum PaymentStatus {
  pending
  success
  failed
  refunded
}

enum CommissionStatus {
  pending
  paid
  failed
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  trial
  lifetime
}

enum WithdrawalStatus {
  pending
  completed
  failed
}

enum PlanType {
  subscription
  one_time
}
